humhub.module("calendar",function(r,t,o){var a=t("ui.widget").Widget,i=t("client"),d=(t("util").object,t("ui.modal")),c=t("action"),n=t("content").Content,l=a.extend(),s=a.extend();s.RECUR_EDIT_MODE_CREATE=0,s.RECUR_EDIT_MODE_THIS=1,s.RECUR_EDIT_MODE_FOLLOWING=2,s.RECUR_EDIT_MODE_ALL=3,s.prototype.init=function(){d.global.$.find(".tab-basic").on("shown.bs.tab",function(e){o("#calendarentry-title").focus()}),d.global.$.find(".tab-participation").on("shown.bs.tab",function(e){o("#calendarentry-participation_mode").focus()}),this.$.find("#calendarentryform-start_date").on("change",function(){var e=o("#calendarentryform-start_date").datepicker("getDate").getTime();o("#calendarentryform-end_date").datepicker("getDate").getTime()<e&&o("#calendarentryform-end_date").val(o("#calendarentryform-start_date").val())}),this.$.find("#calendarentryform-end_date").on("change",function(){var e=o("#calendarentryform-start_date").datepicker("getDate").getTime();o("#calendarentryform-end_date").datepicker("getDate").getTime()<e&&o("#calendarentryform-start_date").val(o("#calendarentryform-end_date").val())}),this.initTimeInput()},s.prototype.setEditMode=function(e){var t=e.$trigger.data("editMode");t==s.RECUR_EDIT_MODE_THIS?(o(".tab-recurrence").hide(),o(".field-calendarentryform-is_public").hide()):(o(".tab-recurrence").show(),o(".field-calendarentryform-is_public").show()),this.$.find(".calendar-edit-mode-back").show(),this.$.find(".recurrence-edit-type").hide(),this.$.find(".calendar-entry-form-tabs").show(),this.$.find("#recurrenceEditMode").val(t)},s.prototype.showEditModes=function(e){this.$.find(".calendar-edit-mode-back").hide(),this.$.find(".recurrence-edit-type").show(),this.$.find(".calendar-entry-form-tabs").hide()},s.prototype.initTimeInput=function(e){d.global.$.find(".timeField").find(".form-control").each(function(){var e=o(this);e.prop("disabled")&&e.data("oldVal",e.val()).val("")})},s.prototype.toggleDateTime=function(e){var t=d.global.$.find(".timeField"),n=t.find(".form-control"),r=d.global.$.find(".timeZoneField");e.$trigger.prop("checked")?(n.prop("disabled",!0),n.each(function(){o(this).data("oldVal",o(this).val()).val("")}),t.css("opacity","0.2"),r.hide()):(n.each(function(){var e=o(this);e.data("oldVal")&&e.val(e.data("oldVal"))}),n.prop("disabled",!1),t.css("opacity","1.0"),r.show())},s.prototype.changeTimezone=function(e){var t=this.$.find(".timeZoneInput");this.$.find(".calendar-timezone").text(t.find("option:selected").text()),t.hide()},s.prototype.toggleTimezoneInput=function(e){this.$.find(".timeZoneInput").fadeToggle()},s.prototype.changeEventType=function(e){var t=e.$trigger.find(":selected");t.data("type-color")&&(o(".colorpicker-element").data("colorpicker").color.setColor(t.data("type-color")),o(".colorpicker-element").data("colorpicker").update())},s.prototype.toggleRecurring=function(e){o(".calendar-entry-form-tabs .tab-recurrence").parent().toggle(e.$trigger.is(":checked"))},s.prototype.toggleReminder=function(e){o(".calendar-entry-form-tabs .tab-reminder").parent().toggle(e.$trigger.is(":checked"))};var f=n.extend();f.prototype.toggleClose=function(e){this.update(i.post(e))},f.prototype.reload=function(e){return this.parent().reload()},f.prototype.update=function(e){this.loader(),e.then(o.proxy(this.handleUpdateSuccess,this)).catch(f.handleUpdateError).finally(o.proxy(this.loader,this,!1))},f.prototype.loader=function(e){this.streamEntry().loader(e)},f.prototype.handleUpdateSuccess=function(e){return this.streamEntry().replace(e.output).catch(function(e){r.log.error(e,!0)})},f.handleUpdateError=function(e){r.log.error(e,!0)},f.prototype.streamEntry=function(){return this.parent()};var p=function(){return a.instance("#calendar")};r.export({Calendar:l,respond:function(n){n.block=c.BLOCK_MANUAL,i.post(n).then(function(t){t.success?a.closest(n.$trigger).reload().then(function(){r.log.success("saved")}):(r.log.error(e,!0),n.finish())}).catch(function(e){r.log.error(e,!0),n.finish()})},editModal:function(e){a.closest(e.$trigger).loader(),d.load(e).then(function(e){d.global.$.one("submitted",function(){var e=p();e&&e.fetch()})}).catch(function(e){r.log.error(e,!0)})},deleteEvent:function(t){a.closest(t.$trigger).loader(),d.confirm().then(function(e){e?i.post(t).then(function(){d.global.close()}).catch(function(e){r.log.error(e,!0)}):a.closest(t.$trigger).loader(!1)}).finally(function(){t.finish()})},CalendarEntry:f,Form:s})});