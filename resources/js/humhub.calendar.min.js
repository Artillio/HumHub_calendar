humhub.module("calendar",function(o,t,r){var i=t("ui.widget").Widget,a=t("client"),c=(t("util").object,t("ui.modal")),d=t("action"),n=t("content").Content,l=t("event"),s=i.extend(),f=i.extend();f.RECUR_EDIT_MODE_CREATE=0,f.RECUR_EDIT_MODE_THIS=1,f.RECUR_EDIT_MODE_FOLLOWING=2,f.RECUR_EDIT_MODE_ALL=3,f.prototype.init=function(){c.global.$.find(".tab-basic").on("shown.bs.tab",function(t){r("#calendarentry-title").focus()}),c.global.$.find(".tab-participation").on("shown.bs.tab",function(t){r("#calendarentry-participation_mode").focus()}),this.$.find("#calendarentryform-start_date").on("change",function(){var t=r("#calendarentryform-start_date").datepicker("getDate").getTime();r("#calendarentryform-end_date").datepicker("getDate").getTime()<t&&r("#calendarentryform-end_date").val(r("#calendarentryform-start_date").val())}),this.$.find("#calendarentryform-end_date").on("change",function(){var t=r("#calendarentryform-start_date").datepicker("getDate").getTime();r("#calendarentryform-end_date").datepicker("getDate").getTime()<t&&r("#calendarentryform-start_date").val(r("#calendarentryform-end_date").val())}),this.initTimeInput(),this.initSubmitAction()},f.prototype.setEditMode=function(t){var e=t.$trigger.data("editMode");e==f.RECUR_EDIT_MODE_THIS?r(".field-calendarentryform-is_public").hide():r(".field-calendarentryform-is_public").show(),this.$.find(".calendar-edit-mode-back").show(),this.$.find(".recurrence-edit-type").hide(),this.$.find(".calendar-entry-form-tabs").show(),this.$.find("#recurrenceEditMode").val(e)},f.prototype.showEditModes=function(t){this.$.find(".calendar-edit-mode-back").hide(),this.$.find(".recurrence-edit-type").show(),this.$.find(".calendar-entry-form-tabs").hide()},f.prototype.initTimeInput=function(t){c.global.$.find(".timeField").find(".form-control").each(function(){var t=r(this);t.prop("disabled")&&t.data("oldVal",t.val()).val("")})},f.prototype.initSubmitAction=function(){c.global.$.one("submitted",p)};var p=function(t,e){e.reloadWall?(l.trigger("humhub:content:newEntry",e.content,this),l.trigger("humhub:content:afterSubmit",e.content,this)):c.global.$.one("submitted",p)};f.prototype.toggleDateTime=function(t){var e=c.global.$.find(".timeField"),n=e.find(".form-control"),o=c.global.$.find(".timeZoneField");t.$trigger.prop("checked")?(n.prop("disabled",!0),n.each(function(){r(this).data("oldVal",r(this).val()).val("")}),e.css("opacity","0.2"),o.hide()):(n.each(function(){var t=r(this);t.data("oldVal")&&t.val(t.data("oldVal"))}),n.prop("disabled",!1),e.css("opacity","1.0"),o.show())},f.prototype.changeTimezone=function(t){var e=this.$.find(".timeZoneInput");this.$.find(".calendar-timezone").text(e.find("option:selected").text()),e.hide()},f.prototype.toggleTimezoneInput=function(t){this.$.find(".timeZoneInput").fadeToggle()},f.prototype.changeEventType=function(t){var e=t.$trigger.find(":selected");e.data("type-color")&&(r(".colorpicker-element").data("colorpicker").color.setColor(e.data("type-color")),r(".colorpicker-element").data("colorpicker").update())},f.prototype.toggleRecurring=function(t){r(".calendar-entry-form-tabs .tab-recurrence").parent().toggle(t.$trigger.is(":checked"))},f.prototype.toggleReminder=function(t){r(".calendar-entry-form-tabs .tab-reminder").parent().toggle(t.$trigger.is(":checked"))};var u=n.extend();u.prototype.toggleClose=function(t){this.update(a.post(t))},u.prototype.reload=function(t){return this.parent().reload()},u.prototype.update=function(t){this.loader(),t.then(r.proxy(this.handleUpdateSuccess,this)).catch(u.handleUpdateError).finally(r.proxy(this.loader,this,!1))},u.prototype.loader=function(t){this.streamEntry().loader(t)},u.prototype.handleUpdateSuccess=function(t){return this.streamEntry().replace(t.output).catch(function(t){o.log.error(t,!0)})},u.handleUpdateError=function(t){o.log.error(t,!0)},u.prototype.streamEntry=function(){return this.parent()};var h=function(){return i.instance("#calendar")};o.export({Calendar:s,respond:function(n){n.block=d.BLOCK_MANUAL,a.post(n).then(function(t){t.success?i.closest(n.$trigger).reload().then(function(){o.log.success("saved")}):(o.log.error(e,!0),n.finish())}).catch(function(t){o.log.error(t,!0),n.finish()})},editModal:function(t){i.closest(t.$trigger).loader(),c.load(t).then(function(t){c.global.$.one("submitted",function(){var t=h();t&&t.fetch()})}).catch(function(t){o.log.error(t,!0)})},deleteEvent:function(e){i.closest(e.$trigger).loader(),c.confirm().then(function(t){t?a.post(e).then(function(){c.global.close()}).catch(function(t){o.log.error(t,!0)}):i.closest(e.$trigger).loader(!1)}).finally(function(){e.finish()})},CalendarEntry:u,Form:f})});