humhub.module("calendar",function(i,t,d){var o=t("ui.widget").Widget,a=t("client"),l=(t("util").object,t("ui.modal")),r=t("action"),n=t("content").Content,c=t("event"),s=t("stream").StreamEntry,p=o.extend(),u=o.extend();u.RECUR_EDIT_MODE_CREATE=0,u.RECUR_EDIT_MODE_THIS=1,u.RECUR_EDIT_MODE_FOLLOWING=2,u.RECUR_EDIT_MODE_ALL=3,u.prototype.init=function(){var o="#calendarentryform-start_",a="#calendarentryform-end_";function r(e,t){return+t[0]<=+e[0]&&t[1].includes("A")&&(e[1].includes("A")||e[1].includes("P"))||t[1].includes("P")&&e[1].includes("P")}function c(e,t){t[0]=(t[0]<=9?"0":"")+t[0],d(e+"time").val(t.join(":"))}l.global.$.find(".tab-basic").on("shown.bs.tab",function(e){d("#calendarentry-title").focus()}),l.global.$.find(".tab-participation").on("shown.bs.tab",function(e){d("#calendarentry-participation_mode").focus()}),this.$.find(o+"date").on("change",function(){var e=d(o+"date").datepicker("getDate").getTime();d(a+"date").datepicker("getDate").getTime()<e&&d(a+"date").val(d(o+"date").val())}),this.$.find(a+"date").on("change",function(){var e=d(o+"date").datepicker("getDate").getTime();d(a+"date").datepicker("getDate").getTime()<e&&d(o+"date").val(d(a+"date").val())}),this.$.find(o+"time").on("change",function(){var e=d(o+"date").datepicker("getDate").getTime(),t=d(a+"date").datepicker("getDate").getTime(),n=d(o+"time").val().split(":"),i=d(a+"time").val().split(":");e===t&&(n[1].includes("M")?"11"===i[0]&&i[1].includes("P")||r(n,i)&&(i[0]=12==+n[0]?1:+n[0]+1,11==+n[0]?i[1]=n[1].includes("A")?n[1].replace("A","P"):n[1].replace("P","A"):i[1]=n[1].includes("A")?n[1].replace("P","A"):n[1].replace("A","P"),c(a,i)):+i[0]<=+n[0]&&(i[0]=23==+n[0]?0:+n[0]+1,c(a,i)))}),this.$.find(a+"time").on("change",function(){var e=d(o+"date").datepicker("getDate").getTime(),t=d(a+"date").datepicker("getDate").getTime(),n=d(o+"time").val().split(":"),i=d(a+"time").val().split(":");e===t&&(n[1].includes("M")?"12"===n[0]&&n[1].includes("A")||r(n,i)&&(n[0]=1==+i[0]?12:i[0]-1,12==+i[0]?n[1]=i[1].includes("A")?i[1].replace("A","P"):i[1].replace("P","A"):n[1]=i[1].includes("A")?i[1].replace("P","A"):i[1].replace("A","P"),c(o,n)):+i[0]<=+n[0]&&(n[0]=0==+i[0]?23:i[0]-1,c(o,n)))}),this.initTimeInput(),this.initSubmitAction()},u.prototype.setEditMode=function(e){var t=e.$trigger.data("editMode");t==u.RECUR_EDIT_MODE_THIS?d(".field-calendarentryform-is_public").hide():d(".field-calendarentryform-is_public").show(),this.$.find(".calendar-edit-mode-back").show(),this.$.find(".recurrence-edit-type").hide(),this.$.find(".calendar-entry-form-tabs").show(),this.$.find("#recurrenceEditMode").val(t)},u.prototype.showEditModes=function(e){this.$.find(".calendar-edit-mode-back").hide(),this.$.find(".recurrence-edit-type").show(),this.$.find(".calendar-entry-form-tabs").hide()},u.prototype.initTimeInput=function(e){l.global.$.find(".timeField").find(".form-control").each(function(){var e=d(this);e.prop("disabled")&&e.data("oldVal",e.val()).val("")})},u.prototype.initSubmitAction=function(){l.global.$.one("submitted",f)};var f=function(e,t){t.id&&l.global.$.one("hidden.bs.modal",function(){var e=s.getNodeByKey(t.id);e.length&&(e=new s(e)).reload()}),t.reloadWall?(c.trigger("humhub:content:newEntry",t.content,this),c.trigger("humhub:content:afterSubmit",t.content,this)):l.global.$.one("submitted",f)};u.prototype.toggleDateTime=function(e){var t=l.global.$.find(".timeField"),n=t.find(".form-control"),i=l.global.$.find(".timeZoneField");e.$trigger.prop("checked")?(n.prop("disabled",!0),n.each(function(){d(this).data("oldVal",d(this).val()).val("")}),t.css("opacity","0.2"),i.hide()):(n.each(function(){var e=d(this);e.data("oldVal")&&e.val(e.data("oldVal"))}),n.prop("disabled",!1),t.css("opacity","1.0"),i.show())},u.prototype.changeTimezone=function(e){var t=this.$.find(".timeZoneInput");this.$.find(".calendar-timezone").text(t.find("option:selected").text()),t.hide()},u.prototype.toggleTimezoneInput=function(e){this.$.find(".timeZoneInput").fadeToggle()},u.prototype.changeEventType=function(e){var t=e.$trigger.find(":selected");t.data("type-color")&&(d(".colorpicker-element").data("colorpicker").color.setColor(t.data("type-color")),d(".colorpicker-element").data("colorpicker").update())},u.prototype.toggleRecurring=function(e){d(".calendar-entry-form-tabs .tab-recurrence").parent().toggle(e.$trigger.is(":checked"))},u.prototype.toggleReminder=function(e){d(".calendar-entry-form-tabs .tab-reminder").parent().toggle(e.$trigger.is(":checked"))};var h=n.extend();h.prototype.toggleClose=function(e){this.update(a.post(e))},h.prototype.reload=function(e){return this.parent().reload()},h.prototype.update=function(e){this.loader(),e.then(d.proxy(this.handleUpdateSuccess,this)).catch(h.handleUpdateError).finally(d.proxy(this.loader,this,!1))},h.prototype.loader=function(e){this.streamEntry().loader(e)},h.prototype.handleUpdateSuccess=function(e){return this.streamEntry().replace(e.output).catch(function(e){i.log.error(e,!0)})},h.handleUpdateError=function(e){i.log.error(e,!0)},h.prototype.streamEntry=function(){return this.parent()};var g=function(){return o.instance("#calendar")};i.export({Calendar:p,respond:function(n){n.block=r.BLOCK_MANUAL,a.post(n).then(function(t){t.success?o.closest(n.$trigger).reload().then(function(){i.log.success("saved")}):(i.log.error(e,!0),n.finish())}).catch(function(e){i.log.error(e,!0),n.finish()})},editModal:function(e){o.closest(e.$trigger).loader(),l.load(e).then(function(e){l.global.$.one("submitted",function(){var e=g();e&&e.fetch()})}).catch(function(e){i.log.error(e,!0)})},deleteEvent:function(t){o.closest(t.$trigger).loader(),l.confirm().then(function(e){e?a.post(t).then(function(){l.global.close()}).catch(function(e){i.log.error(e,!0)}):o.closest(t.$trigger).loader(!1)}).finally(function(){t.finish()})},CalendarEntry:h,Form:u})});