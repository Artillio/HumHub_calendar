humhub.module("calendar.Calendar",function(i,t,a){var e=t("ui.widget").Widget,r=t("client"),o=t("util").string,n=t("ui.loader"),l=t("ui.view"),s=t("ui.modal"),e=e.extend();e.prototype.init=function(){var n=this;this.options.events=function(t,e,o){a.ajax({url:n.options.loadUrl,type:"GET",data:{start:moment(t.start.valueOf()).format("YYYY-MM-DD"),end:moment(t.end.valueOf()).format("YYYY-MM-DD"),selectors:n.options.selectors,filters:n.options.filters},success:function(t){e(t)}})},i.log.debug("Init calendar: ",this.options),this.initCalendarFilter(),this.updateCalendarFilters()},e.prototype.initCalendarFilter=function(){var t=this;a(".selectorCheckbox").click(function(){t.updateCalendarFilters(!0)}),a(".filterCheckbox").click(function(){"3"==a(this).val()&&a(":checkbox[value=4][name='filter']").attr("checked",!1),"4"==a(this).val()&&a(":checkbox[value=3][name='filter']").attr("checked",!1),t.updateCalendarFilters(!0)})},e.prototype.updateCalendarFilters=function(t){var e=this;this.options.selectors=[],this.options.filters=[],a(".selectorCheckbox").each(function(){a(this).prop("checked")&&e.options.selectors.push(a(this).val())}),a(".filterCheckbox").each(function(){a(this).prop("checked")&&e.options.filters.push(a(this).val())}),this.initFullCalendar(t)},e.prototype.initFullCalendar=function(t){this.fullCalendar&&t?(this.fullCalendar.removeAllEventSources(),this.fullCalendar.addEventSource(this.options.events)):(this.fullCalendar=new FullCalendar.Calendar(this.$[0],this.options),this.fullCalendar.render())},e.prototype.getDefaultOptions=function(){var t={};"today"!==i.text("button.today")&&(t.today=i.text("button.today")),"month"!==i.text("button.month")&&(t.month=i.text("button.month")),"week"!==i.text("button.week")&&(t.week=i.text("button.week")),"day"!==i.text("button.day")&&(t.day=i.text("button.day")),"list"!==i.text("button.list")&&(t.list=i.text("button.list"));t={header:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay,listWeek"},buttonText:t,plugins:["dayGrid","timeGrid","list","interaction","bootstrap","moment","momentTimezone"],defaultView:"dayGridMonth",canCreate:!0,selectable:!0,select:a.proxy(this.select,this),eventAllow:function(){return!0},themeSystem:"bootstrap",loading:a.proxy(this.loader,this),eventResize:a.proxy(this.updateEvent,this),eventDrop:a.proxy(this.updateEvent,this),eventClick:a.proxy(this.clickEvent,this),eventRender:a.proxy(this.renderEvent,this)};return l.isSmall()&&(t.header={left:"prev,next",center:"title",right:"today"},t.footer={center:"dayGridMonth,timeGridWeek,timeGridDay,listWeek"}),t},e.prototype.renderEvent=function(t,e){e=a(e);e.attr({title:e.text()}),t.icon&&o.startsWith(t.icon,"fa-")&&e.find(".fc-content").prepend(a('<i class="fa '+t.icon+'"></i>'))},e.prototype.toJsonDateFormat=function(t,e){return e?FullCalendarMoment.toMoment(t,this.fullCalendar).format("YYYY-MM-DD"):FullCalendarMoment.toMoment(t,this.fullCalendar).format()},e.prototype.select=function(t){var e=this,o={data:{start:this.toJsonDateFormat(t.start,!1),end:this.toJsonDateFormat(t.end,!1),cal:1}},t=this.options.global?this.options.globalCreateUrl:this.options.editUrl;s.global.load(t,o).then(function(){s.global.$.one("hidden.bs.modal submitted",function(){e.fetch()})}).catch(function(t){s.global.close(),i.log.error(t,!0)}),this.fullCalendar.unselect()},e.prototype.fetch=function(){this.fullCalendar.refetchEvents()},e.prototype.updateEvent=function(e){var o=this,t=e.event,n=t.extendedProps,t={data:{id:t.id,start:this.toJsonDateFormat(t.start,t.allDay),end:this.toJsonDateFormat(t.end,t.allDay)}};this.loader(),r.post(n.updateUrl,t).then(function(t){t.success?i.log.success("saved"):i.log.error(t,!0),n.refreshAfterUpdate&&o.fetch()}).catch(function(t){i.log.error(t,!0),e.revert()}).finally(function(){o.loader(!1)})},e.prototype.clickEvent=function(t){var e,t=t.event.extendedProps;t.viewUrl&&(e=this,"modal"===t.viewMode?s.global.load(t.viewUrl,{viewContext:"fullCalendar"}).then(function(){s.global.set({backdrop:!0}),s.global.$.one("hidden.bs.modal",function(){e.fetch()})}).catch(function(t){i.log.error(t,!0),s.global.close()}):r.pjax.redirect(t.viewUrl))},e.prototype.loader=function(t){!1===t?n.reset(a("#calendar-overview-loader")):n.set(a("#calendar-overview-loader"),{size:"8px",css:{padding:"2px ",width:"60px"}})},i.export=e});